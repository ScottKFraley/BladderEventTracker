<div class="container-fluid p-3">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="fas fa-bug"></i> Enhanced Debug Console
        <span class="badge bg-info ms-2">v2.0</span>
      </h2>
      <p class="text-muted">Comprehensive debugging for authentication and mobile issues</p>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5><i class="fas fa-play"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-primary w-100" (click)="refreshDebugInfo()">
                <i class="fas fa-sync"></i> Refresh Info
              </button>
            </div>
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-success w-100" (click)="testConnection()" [disabled]="isTestingConnection">
                <i class="fas fa-wifi"></i> {{isTestingConnection ? 'Testing...' : 'Test Connection'}}
              </button>
            </div>
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-warning w-100" (click)="forceTokenRefresh()">
                <i class="fas fa-key"></i> Force Token Refresh
              </button>
            </div>
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-info w-100" (click)="exportDebugInfo()">
                <i class="fas fa-download"></i> Export Debug Info
              </button>
            </div>
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-secondary w-100" (click)="clearLogs()">
                <i class="fas fa-trash"></i> Clear Logs
              </button>
            </div>
            <div class="col-md-6 col-lg-4 mb-2">
              <button class="btn btn-danger w-100" (click)="clearAuthTokens()">
                <i class="fas fa-sign-out-alt"></i> Clear Auth Tokens
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6 mb-2">
              <button class="btn btn-outline-primary w-100" (click)="goToDashboard()">
                <i class="fas fa-tachometer-alt"></i> Go to Dashboard
              </button>
            </div>
            <div class="col-md-6 mb-2">
              <button class="btn btn-outline-secondary w-100" (click)="goToLogin()">
                <i class="fas fa-sign-in-alt"></i> Go to Login
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Status -->
  <div class="row mb-4" *ngIf="debugInfo">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="fas fa-user-shield"></i> Authentication Status</h5>
          <span [class]="debugInfo.user.isAuthenticated ? 'badge bg-success' : 'badge bg-danger'">
            {{debugInfo.user.isAuthenticated ? 'Authenticated' : 'Not Authenticated'}}
          </span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Username:</strong> {{debugInfo.user.username || 'N/A'}}</p>
              <p><strong>User ID:</strong> {{debugInfo.user.userId || 'N/A'}}</p>
              <p><strong>Roles:</strong> {{debugInfo.user.roles.length > 0 ? debugInfo.user.roles.join(', ') : 'None'}}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Token Expires:</strong> {{getTokenExpiration()}}</p>
              <p><strong>Has Access Token:</strong> 
                <span [class]="debugInfo.authentication.hasAccessToken ? 'text-success' : 'text-danger'">
                  {{debugInfo.authentication.hasAccessToken ? 'Yes' : 'No'}}
                </span>
              </p>
              <p><strong>Has Refresh Token:</strong> 
                <span [class]="debugInfo.authentication.hasRefreshToken ? 'text-success' : 'text-danger'">
                  {{debugInfo.authentication.hasRefreshToken ? 'Yes' : 'No'}}
                </span>
              </p>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <p><strong>Token Refresh Count:</strong> {{debugInfo.authentication.tokenRefreshCount}}</p>
              <p><strong>Last Auth Attempt:</strong> {{debugInfo.authentication.lastAuthAttempt || 'Never'}}</p>
              <p><strong>Last Successful Auth:</strong> {{debugInfo.authentication.lastSuccessfulAuth || 'Never'}}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Patterns Alert -->
  <div class="row mb-4" *ngIf="errorPatterns.length > 0">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
          <h5><i class="fas fa-exclamation-triangle"></i> Error Patterns Detected</h5>
        </div>
        <div class="card-body">
          <div *ngFor="let pattern of errorPatterns" class="mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span [class]="getErrorSeverityClass(pattern.severity)">
                <strong>{{pattern.pattern}}</strong> ({{pattern.occurrences}} times in {{pattern.timeWindow}})
              </span>
              <span [class]="getErrorSeverityClass(pattern.severity)">{{pattern.severity.toUpperCase()}}</span>
            </div>
            <small class="text-muted">Suggested: {{pattern.suggestedAction}}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Connection Test Result -->
  <div class="row mb-4" *ngIf="connectionTestResult">
    <div class="col-12">
      <div class="card" [class]="connectionTestResult.success ? 'border-success' : 'border-danger'">
        <div class="card-header" [class]="connectionTestResult.success ? 'bg-success text-white' : 'bg-danger text-white'">
          <h5><i class="fas fa-wifi"></i> Connection Test Result</h5>
        </div>
        <div class="card-body">
          <p><strong>Status:</strong> {{connectionTestResult.success ? 'SUCCESS' : 'FAILED'}}</p>
          <p><strong>Message:</strong> {{connectionTestResult.message}}</p>
          <p><strong>Timestamp:</strong> {{connectionTestResult.timestamp}}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Collapsible Sections -->
  <div class="row">
    <!-- Error History -->
    <div class="col-12 mb-3">
      <div class="card">
        <div class="card-header">
          <button class="btn btn-link text-decoration-none p-0 w-100 text-start" (click)="toggleErrorHistory()">
            <h5><i class="fas fa-history"></i> Error History 
              <span class="badge bg-danger ms-2" *ngIf="authErrors.length > 0">{{authErrors.length}}</span>
              <i [class]="showErrorHistory ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="float-end"></i>
            </h5>
          </button>
        </div>
        <div class="card-body" *ngIf="showErrorHistory">
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-danger" (click)="clearErrorHistory()">
              <i class="fas fa-trash"></i> Clear Error History
            </button>
            <button class="btn btn-sm btn-outline-warning ms-2" (click)="simulateNetworkError()">
              <i class="fas fa-exclamation"></i> Simulate Error
            </button>
          </div>
          <div *ngIf="authErrors.length === 0" class="text-muted">No authentication errors recorded</div>
          <div *ngFor="let error of authErrors.slice(0, 10)" class="mb-3 p-2 border-start border-danger border-3">
            <div class="d-flex justify-content-between">
              <strong class="text-danger">{{error.errorCode}} ({{error.statusCode}})</strong>
              <small class="text-muted">{{formatLogTimestamp(error.timestamp)}}</small>
            </div>
            <p class="mb-1">{{error.userFriendlyMessage || error.message}}</p>
            <small class="text-info">Auth State: {{error.authenticationState}} | Suggested: {{error.suggestedAction}}</small>
            <div *ngIf="error.correlationId" class="mt-1">
              <small class="text-muted">Correlation ID: {{error.correlationId}}</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Application Insights Logs -->
    <div class="col-12 mb-3">
      <div class="card">
        <div class="card-header">
          <button class="btn btn-link text-decoration-none p-0 w-100 text-start" (click)="toggleAppInsightsLogs()">
            <h5><i class="fas fa-chart-line"></i> Application Insights Logs
              <span class="badge bg-info ms-2" *ngIf="!isAppInsightsConfigured()">Mock Data</span>
              <span class="badge bg-success ms-2" *ngIf="appInsightsLogs.length > 0">{{appInsightsLogs.length}}</span>
              <i [class]="showAppInsightsLogs ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="float-end"></i>
            </h5>
          </button>
        </div>
        <div class="card-body" *ngIf="showAppInsightsLogs">
          <!-- Configuration Status -->
          <div class="alert alert-info" *ngIf="!isAppInsightsConfigured()">
            <i class="fas fa-info-circle"></i> Application Insights not configured. Showing mock data for demonstration.
            <br><small>App ID: {{getAppInsightsConfigStatus().appId}} | API Key: {{getAppInsightsConfigStatus().hasApiKey ? 'Present' : 'Missing'}}</small>
          </div>

          <!-- Log Controls -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Log Type:</label>
              <select class="form-select" [(ngModel)]="selectedLogFilter" (change)="onLogFilterChange()">
                <option value="recent">Recent Logs (1 hour)</option>
                <option value="auth">Authentication Logs (24h)</option>
                <option value="errors">Error Logs (24h)</option>
                <option value="performance">Performance Logs (1h)</option>
                <option value="search">Search Logs</option>
                <option value="correlation">By Correlation ID</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Actions:</label>
              <div class="btn-group w-100">
                <button class="btn btn-primary" (click)="loadLogs()" [disabled]="isLoadingLogs">
                  <i class="fas fa-sync"></i> {{isLoadingLogs ? 'Loading...' : 'Refresh'}}
                </button>
                <button class="btn btn-secondary" (click)="exportAppInsightsLogs()">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
          </div>

          <!-- Search Controls -->
          <div class="row mb-3" *ngIf="selectedLogFilter === 'search'">
            <div class="col-12">
              <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="searchTerm" placeholder="Enter search term...">
                <button class="btn btn-outline-primary" (click)="searchLogs()">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
            </div>
          </div>

          <div class="row mb-3" *ngIf="selectedLogFilter === 'correlation'">
            <div class="col-12">
              <div class="input-group">
                <input type="text" class="form-control" [(ngModel)]="correlationIdSearch" placeholder="Enter correlation ID...">
                <button class="btn btn-outline-primary" (click)="searchByCorrelationId()">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
            </div>
          </div>

          <!-- Query Results Summary -->
          <div class="alert alert-secondary" *ngIf="logsQueryResult">
            <i class="fas fa-info-circle"></i> Found {{logsQueryResult.totalResults}} entries in {{logsQueryResult.queryDuration}}ms
            (Last fetched: {{formatLogTimestamp(logsQueryResult.lastFetched)}})
          </div>

          <!-- Log Entries -->
          <div *ngIf="appInsightsLogs.length === 0 && !isLoadingLogs" class="text-muted text-center py-3">
            No log entries found. Click "Refresh" to load logs.
          </div>

          <div *ngFor="let log of appInsightsLogs" class="mb-2 p-2 border rounded">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <span [class]="getLogSourceBadgeClass(log.source)">{{log.source}}</span>
                  <span [class]="getLogLevelClass(log.level)" class="ms-2 fw-bold">{{log.level.toUpperCase()}}</span>
                  <small class="text-muted ms-2">{{formatLogTimestamp(log.timestamp)}}</small>
                </div>
                <p class="mb-1">{{log.message}}</p>
                <div *ngIf="log.correlationId || log.userId" class="mb-1">
                  <small class="text-muted">
                    <span *ngIf="log.correlationId">Correlation: {{log.correlationId}}</span>
                    <span *ngIf="log.userId" class="ms-2">User: {{log.userId}}</span>
                  </small>
                </div>
                <div *ngIf="log.details" class="mt-2">
                  <details>
                    <summary class="text-info" style="cursor: pointer;">View Details</summary>
                    <pre class="bg-light p-2 mt-1 small">{{formatLogDetails(log.details)}}</pre>
                  </details>
                </div>
              </div>
              <button class="btn btn-sm btn-outline-secondary ms-2" (click)="copyLogToClipboard(log)">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- System Information -->
    <div class="col-12 mb-3">
      <div class="card">
        <div class="card-header">
          <button class="btn btn-link text-decoration-none p-0 w-100 text-start" (click)="toggleSystemInfo()">
            <h5><i class="fas fa-desktop"></i> System Information
              <i [class]="showSystemInfo ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="float-end"></i>
            </h5>
          </button>
        </div>
        <div class="card-body" *ngIf="showSystemInfo && debugInfo">
          <div class="row">
            <div class="col-md-6">
              <h6>Network Status</h6>
              <p><strong>Status:</strong> 
                <span [class]="debugInfo.system.networkStatus === 'online' ? 'text-success' : 
                              debugInfo.system.networkStatus === 'offline' ? 'text-danger' : 'text-warning'">
                  {{debugInfo.system.networkStatus.toUpperCase()}}
                </span>
              </p>
              <p><strong>Connection Type:</strong> {{debugInfo.system.connectionType}}</p>
              
              <h6>Performance</h6>
              <p><strong>Page Load:</strong> {{debugInfo.system.performance.pageLoadTime}}ms</p>
              <p><strong>Memory Usage:</strong> {{debugInfo.system.performance.memoryUsage || 'N/A'}}</p>
              <p><strong>Connection Speed:</strong> {{debugInfo.system.performance.connectionSpeed}}</p>
            </div>
            <div class="col-md-6">
              <h6>Browser Info</h6>
              <p><strong>User Agent:</strong></p>
              <small class="text-muted">{{debugInfo.system.userAgent}}</small>
              
              <h6 class="mt-3">Cookies</h6>
              <p><strong>Auth Cookie:</strong> 
                <span [class]="debugInfo.system.cookieInfo.authCookiePresent ? 'text-success' : 'text-danger'">
                  {{debugInfo.system.cookieInfo.authCookiePresent ? 'Present' : 'Missing'}}
                </span>
              </p>
              <p><strong>Refresh Cookie:</strong> 
                <span [class]="debugInfo.system.cookieInfo.refreshCookiePresent ? 'text-success' : 'text-danger'">
                  {{debugInfo.system.cookieInfo.refreshCookiePresent ? 'Present' : 'Missing'}}
                </span>
              </p>
              <p><strong>Secure:</strong> {{debugInfo.system.cookieInfo.secure ? 'Yes' : 'No'}}</p>
            </div>
          </div>

          <!-- Storage Information -->
          <div class="row mt-3">
            <div class="col-md-6">
              <h6>LocalStorage</h6>
              <div class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                <pre class="small mb-0">{{debugInfo.system.localStorage | json}}</pre>
              </div>
            </div>
            <div class="col-md-6">
              <h6>SessionStorage</h6>
              <div class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                <pre class="small mb-0">{{debugInfo.system.sessionStorage | json}}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Console Logs -->
    <div class="col-12 mb-3">
      <div class="card">
        <div class="card-header">
          <button class="btn btn-link text-decoration-none p-0 w-100 text-start" (click)="toggleDetailedLogs()">
            <h5><i class="fas fa-terminal"></i> Console Logs
              <span class="badge bg-primary ms-2">{{logs.length}}</span>
              <i [class]="showDetailedLogs ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="float-end"></i>
            </h5>
          </button>
        </div>
        <div class="card-body" *ngIf="showDetailedLogs">
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-secondary" (click)="clearLogs()">
              <i class="fas fa-trash"></i> Clear Console Logs
            </button>
          </div>
          <div class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
            <div *ngFor="let log of logs" class="mb-1">
              <small>{{log}}</small>
            </div>
            <div *ngIf="logs.length === 0" class="text-muted">No console logs captured yet</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="text-center text-muted">
        <small>Enhanced Debug Console v2.0 | Last Updated: {{debugInfo?.system?.timestamp | date:'medium'}}</small>
      </div>
    </div>
  </div>
</div>